<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8">
  <title th:text="${trip.title} + ' | TRIP ON'">Ïó¨Ìñâ ÌõÑÍ∏∞ | TRIP ON</title>
  <link href="https://fonts.googleapis.com/css?family=Noto+Sans+KR:400,500,700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css?family=Bagel+Fat+One&display=swap" rel="stylesheet">
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      background-color: #fff;
      font-family: 'Noto Sans KR', sans-serif;
      padding: 20px 60px;
      min-height: 100vh;
      position: relative;
    }

    /* Î©îÏù∏ ÏΩòÌÖêÏ∏† */
    .container {
      display: flex;
      gap: 60px;
      margin-top: 40px;
      position: relative;
    }

    .left-info {
      width: 370px;
      min-width: 320px;
      border-right: 2px solid #888;
      padding-right: 40px;
      box-sizing: border-box;
      margin-left: 30px;
    }

    .trip-title-row {
      display: flex;
      align-items: center;
      margin-bottom: 20px;
    }

    .trip-title {
      font-family: 'Inter', sans-serif;
      font-weight: 800;
      font-size: 32px;
      margin-right: 16px;
    }

    .trip-menu-box {
      display: flex;
      gap: 8px;
    }

    .menu-dot.left {
      background: none;
      border: none;
      padding: 0;
      line-height: 1;
      font-size: 32px;
      cursor: pointer;
      margin-left: 16px;
      margin-top: -20px;
      position: static;
    }

    .trip-menu-popup {
      position: absolute;
      top: 40px;
      left: -20px;
      background: #fff;
      border: 1px solid #ccc;
      border-radius: 16px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
      padding: 12px 16px;
      display: none;
      flex-direction: row;
      gap: 12px;
      z-index: 10;
    }

    .trip-menu-btn {
      background: #f5f5f5;
      border: 1.5px solid #888;
      border-radius: 8px;
      font-size: 16px;
      padding: 6px 18px;
      cursor: pointer;
      white-space: nowrap;
      width: auto;
      line-height: 1.2;
      display: inline-block;
      color: #222;
      text-align: center;
    }

    .menu-btn {
      background: #DBDBDB;
      border-radius: 30px;
      padding: 8px 16px;
      font-size: 16px;
      color: #000;
      cursor: pointer;
      transition: all 0.3s ease;
      border: none;
    }

    .menu-btn:hover {
      background: #000;
      color: #fff;
    }

    .info-table {
      margin-bottom: 32px;
    }

    .info-row {
      display: flex;
      margin-bottom: 16px;
      font-size: 18px;
    }

    .info-label {
      width: 70px;
      color: #000;
      font-weight: 500;
    }

    .info-value {
      color: #000;
      font-weight: 400;
    }

    .tag-list {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .tag {
      display: inline-block;
      border: 1.5px solid #888;
      border-radius: 30px;
      padding: 4px 16px;
      font-size: 16px;
      color: #222;
      background: #f5f5f5;
      border-color: #888;
    }

    .info-link {
      color: #0077cc;
      text-decoration: none;
      cursor: pointer;
      margin-left: 8px;
    }

    .info-link:hover {
      text-decoration: underline;
    }

    .info-link.disabled {
      pointer-events: none;
      cursor: default;
      color: #888;
      text-decoration: none;
    }

    .info-invite {
      color: #000;
      text-decoration: underline;
      cursor: pointer;
    }

    .side-btns {
      margin-top: 40px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .side-btn {
      text-decoration: none !important;
      border: 1.5px solid #bbb;
      width: 100%;
      border-radius: 8px;
      padding: 6px 18px;
      background: #fff;
      color: #222;
      font-size: 16px;
      cursor: pointer;
      margin-bottom: 16px;
      text-align: center;
      transition: background 0.2s, color 0.2s;
    }

    .side-btn.selected {
      background: #000;
      color: #fff;
      border: 1.5px solid #000;
    }

    .side-btn:hover {
      background: #000;
      color: #fff;
    }

    .right-content {
      flex: 1;
      min-width: 0;
      padding: 0 0 24px 0;
      max-width: 800px;
      width: 100%;
    }

    .edit-row {
      display: flex;
      align-items: center;
      justify-content: flex-end;
      margin-bottom: 20px;
    }

    .edit-label {
      background: #DBDBDB;
      border-radius: 30px;
      padding: 8px 16px;
      font-size: 16px;
      color: #000;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .edit-label:hover {
      background: #000;
      color: #fff;
    }

    .days-row {
      display: flex;
      gap: 40px;
      margin-bottom: 30px;
    }

    .day-col {
      min-width: 220px;
      position: relative;
    }

    .day-title {
      font-family: 'Inter', sans-serif;
      font-weight: 800;
      font-size: 18px;
      text-align: center;
      margin-bottom: 20px;
    }

    .schedule-list {
      display: flex;
      flex-direction: column;
      gap: 16px;
      margin-bottom: 12px;
      width: 100%;
      max-height: 250px;
      overflow-y: auto;
    }

    .schedule-item {
      display: flex;
      align-items: center;
      background: #DBDBDB;
      border-radius: 8px;
      padding: 6px 18px;
      font-size: 16px;
      color: #000;
      gap: 12px;
    }

    .schedule-time {
      font-weight: 700;
      min-width: 54px;
      color: #555;
      font-family: 'Inter', 'Noto Sans KR', sans-serif;
    }

    .schedule-content {
      flex: 1;
      color: #222;
      word-break: break-all;
    }

    .back-link {
      position: absolute;
      top: 80px;
      right: 80px;
      font-size: 16px;
      color: #000;
      text-decoration: none;
      transition: all 0.3s ease;
    }

    .back-link:hover {
      color: #666;
    }

    .edit-day-link {
      position: absolute;
      top: 8px;
      left: -30px;
      font-size: 13px;
      color: #000;
      font-weight: 400;
      text-decoration: underline;
      cursor: pointer;
      transition: color 0.2s;
    }

    .edit-day-link:hover {
      color: #666;
    }

    @media (max-width: 1100px) {
      .container {
        flex-direction: column;
        gap: 40px;
      }

      .left-info {
        width: 100%;
        min-width: 0;
        border-right: none;
        padding-right: 0;
      }

      .days-row {
        gap: 20px;
      }
    }

    @media (max-width: 700px) {
      body {
        padding: 20px;
      }

      .top-bar {
        flex-direction: column;
        gap: 10px;
      }

      .logo {
        font-size: 28px;
      }

      .container {
        gap: 30px;
      }

      .trip-title {
        font-size: 24px;
      }

      .trip-menu-box {
        font-size: 14px;
        padding: 6px 12px;
      }

      .info-row {
        font-size: 16px;
      }

      .side-btn {
        width: 100%;
        height: 40px;
        font-size: 14px;
      }

      .days-row {
        flex-direction: column;
        gap: 20px;
      }

      .day-col {
        min-width: 0;
      }

      .back-link {
        top: 20px;
        right: 20px;
        font-size: 14px;
      }
    }

    .trip-info-box {
      margin-left: 30px;
    }

    .schedule-add-btn {
      background: #fff;
      border: 1.5px solid #bbb;
      border-radius: 8px;
      padding: 6px 18px;
      font-size: 16px;
      color: #222;
      cursor: pointer;
      transition: all 0.2s;
      align-self: stretch;
      margin-bottom: 8px;
      width: 100%;
      text-align: center;
    }

    .schedule-add-btn:hover {
      background: #eee;
      color: #222;
    }

    #saveInfoBtn {
      display: none;
      margin-top: 8px;
      width: auto;
      border-radius: 6px;
      padding: 4px 16px;
      background: #fff;
      color: #000;
      font-size: 16px;
      border: none;
      cursor: pointer;
      margin-left: auto;
    }

    /* ÌõÑÍ∏∞(Ïò§Î•∏Ï™Ω) ÏòÅÏó≠ Ïä§ÌÉÄÏùº Ï∂îÍ∞Ä */
    .review-list {
      display: flex;
      flex-direction: column;
      gap: 16px;
      max-height: 500px;
      overflow-y: auto;
      background: #fff;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.03);
    }

    .review-card {
      padding: 20px 0 8px 0;
      border-bottom: 1px solid #ccc;
      position: relative;
    }

    .review-header {
      display: flex;
      justify-content: flex-start;
      align-items: flex-start;
      margin-bottom: 4px;
      position: relative;
    }

    .review-author {
      font-size: 20px;
      font-weight: 700;
      margin-bottom: 4px;
    }

    .review-menu {
      text-align: right;
      color: #e74c3c;
      font-size: 16px;
      line-height: 1.2;
    }

    .review-menu-text {
      color: #e74c3c;
      font-size: 15px;
    }

    .review-content {
      font-size: 18px;
      margin-bottom: 12px;
      margin-top: 0;
    }

    .review-images {
      display: flex;
      gap: 10px;
      margin-bottom: 6px;
    }

    .review-image {
      width: 80px;
      height: 80px;
      background: #d9d9d9;
      border-radius: 8px;
      cursor: pointer;
    }

    .review-limit {
      color: #e74c3c;
      font-size: 13px;
      margin-left: 4px;
      align-self: flex-end;
    }

    .review-meta {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 14px;
      color: #888;
      margin-top: 6px;
    }

    .review-date {
      font-size: 14px;
      color: #888;
    }

    .review-like {
      font-size: 22px;
      color: #111;
      margin-left: 4px;
      display: flex;
      align-items: center;
      gap: 2px;
    }

    .review-like.heart {
      color: #e74c3c;
    }

    .review-scroll {
      color: #e74c3c;
      font-size: 13px;
      margin-top: 6px;
      text-align: right;
    }

    .review-input-area {
      background: #dbdbdb;
      border-radius: 18px;
      padding: 0 24px;
      display: flex;
      align-items: center;
      gap: 0;
      margin-top: 16px;
      margin-bottom: 0;
      box-sizing: border-box;
      width: 100%;
      min-height: 60px;
      height: 60px;
    }

    .review-input {
      flex: 1;
      border: none;
      background: transparent;
      font-size: 22px;
      color: #444;
      outline: none;
      padding: 0;
      margin-left: 4px;
    }

    .review-input::placeholder {
      color: #888;
      font-size: 22px;
    }

    .review-attach {
      background: none;
      border: none;
      color: #222;
      font-size: 16px;
      text-decoration: underline;
      margin-right: 18px;
      margin-left: 12px;
      cursor: pointer;
      border-radius: 0;
      padding: 0;
      height: 100%;
      transition: background 0.2s;
    }

    .review-submit {
      background: #fff;
      border: none;
      border-radius: 16px;
      font-size: 20px;
      font-weight: 600;
      color: #222;
      width: 64px;
      height: 44px;
      margin-left: 0;
      cursor: pointer;
      box-shadow: none;
      transition: background 0.2s;
    }

    .review-submit:hover {
      background: #f2f2f2;
    }

    .review-file-list {
      width: 100%;
      font-size: 14px;
      color: #444;
      margin-top: 8px;
    }

    @media (max-width: 900px) {
      .right-content {
        max-width: 100vw;
      }

      .review-input-area {
        min-height: 48px;
        height: 48px;
        padding: 0 8px;
      }

      .review-input {
        font-size: 16px;
      }

      .review-input::placeholder {
        font-size: 16px;
      }

      .review-submit {
        font-size: 16px;
        width: 48px;
        height: 32px;
      }
    }

    .review-like-heart {
      position: absolute;
      right: 0;
      bottom: 8px;
      z-index: 1;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    /* ÌõÑÍ∏∞ ÏàòÏ†ï Ï†ÄÏû•/Ï∑®ÏÜå Î≤ÑÌäº Ïä§ÌÉÄÏùº */
    .review-edit-btn2,
    .review-cancel-btn2 {
      border-radius: 8px;
      border: 1.5px solid #bbb;
      background: #fff;
      font-size: 14px;
      padding: 6px 18px;
      margin-left: 4px;
      cursor: pointer;
      transition: background 0.2s;
    }

    .review-edit-btn2:hover,
    .review-cancel-btn2:hover {
      background: #f2f2f2;
    }

    .review-edit-input {
      width: 75%;
      min-width: 300px;
      border-radius: 8px;
      padding: 6px 18px;
      font-size: 16px;
      border: 1.5px solid #bbb;
      outline: none;
      margin-right: 4px;
    }

    /* ÌõÑÍ∏∞ Ïπ¥ÎìúÏùò ... Î≤ÑÌäº ÌÅ¥Î¶≠ Ïãú Î©îÎâ¥ ÌÜ†Í∏Ä */
    .menu-dot.review {
      position: absolute;
      right: 0;
      top: 0;
      font-size: 28px;
      background: none;
      border: none;
      cursor: pointer;
      z-index: 2;
      margin: 0;
    }

    .review-menu-popup {
      position: absolute;
      top: 32px;
      right: 0;
      background: #fff;
      border: 1px solid #ccc;
      border-radius: 16px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
      padding: 12px 16px;
      display: none;
      flex-direction: row;
      gap: 12px;
      z-index: 10;
    }

    .review-menu-btn {
      background: #f5f5f5;
      border: 1.5px solid #888;
      border-radius: 8px;
      font-size: 16px;
      padding: 6px 18px;
      cursor: pointer;
      white-space: nowrap;
      width: auto;
      line-height: 1.2;
      display: inline-block;
      color: #222;
      text-align: center;
    }

    .review-menu-btn:hover {
      background: #e0e0e0;
      border-color: #888;
      color: #222;
    }

    .photo-add-btn {
      width: 80px;
      height: 80px;
      border-radius: 8px;
      border: 2px dashed #bbb;
      background: #fafafa;
      font-size: 40px;
      color: #bbb;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: border-color 0.2s, color 0.2s;
    }

    .photo-add-btn:hover {
      border-color: #888;
      color: #888;
    }

    /* ... Î©îÎâ¥(¬∑¬∑¬∑) Î≤ÑÌäº Ïä§ÌÉÄÏùº: ÏïÑÏù¥ÏΩò Î≤ÑÌäº, ÌÅ¨Í∏∞/Ï†ïÎ†¨/ÎßàÏßÑ Ï°∞Ï†ï ... */
    .menu-dot {
      background: none;
      border: none;
      border-radius: 0;
      width: auto;
      height: auto;
      font-size: 32px;
      cursor: pointer;
      margin-left: 4px;
      padding: 0;
      vertical-align: middle;
    }

    /* ... Î©îÎâ¥ ÌåùÏóÖ(Ìé∏Ïßë/ÏÇ≠Ï†ú) Ïª®ÌÖåÏù¥ÎÑà: Îë•Í∏ÄÍ≥† Í∑∏Î¶ºÏûê, Í∞ÄÎ°ú Ï†ïÎ†¨ ... */
    .menu-popup {
      background: #fff;
      border: 1px solid #ccc;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
      border-radius: 16px;
      padding: 0;
      min-width: unset;
      width: 120px;
      height: 110px;
      position: absolute;
      top: 40px;
      right: 0;
      z-index: 10;
      left: 100px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
    }

    .menu-list {
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }

    .menu-item {
      width: 100%;
      justify-content: flex-start;
      text-align: left;
      padding: 10px 16px;
      font-size: 15px;
      border-radius: 0;
      display: flex;
      align-items: center;
      gap: 8px;
      color: #222;
      cursor: pointer;
      transition: background 0.2s;
    }

    .menu-item:hover {
      background: #f5f5f5;
    }

    .menu-icon {
      font-size: 22px;
    }

    /* ÌÉúÍ∑∏ Ïä§ÌÉÄÏùº plan.htmlÍ≥º ÎèôÏùºÌïòÍ≤å */
    .tag-list .tag {
      margin-right: 8px;
      font-size: 14px;
      color: #555;
    }
    .invite-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.08);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .invite-modal-content {
            background: #ddd;
            border-radius: 20px;
            padding: 36px 32px 24px 32px;
            min-width: 420px;
            max-width: 90vw;
            box-shadow: 0 4px 24px rgba(0, 0, 0, 0.08);
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .invite-title {
            font-size: 16px;
            text-align: center;
            margin-bottom: 36px;
            font-weight: 400;
        }

        .invite-form-row {
            display: flex;
            width: 100%;
            gap: 16px;
            margin-bottom: 16px;
        }

        .invite-input {
            flex: 1 1 0;
            border: none;
            border-radius: 12px;
            padding: 10px 12px;
            font-size: 15px;
            background: #fff;
            outline: none;
        }

        .invite-send-btn {
            border: none;
            border-radius: 12px;
            background: #fff;
            font-size: 15px;
            padding: 10px 12px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .invite-send-btn:hover {
            background: #eee;
        }

        .invite-message {
            width: 100%;
            font-size: 13px;
            margin-bottom: 4px;
        }

        .invite-error {
            color: #c44;
        }

        .invite-success {
            color: #c44;
        }

        .invite-close-btn {
            margin-top: 24px;
            border: none;
            border-radius: 12px;
            background: #fff;
            font-size: 15px;
            padding: 6px 32px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .invite-close-btn:hover {
            background: #eee;
        }

        .invite-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.3);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .invite-modal-content {
            background: #fff;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
            width: 420px;
        }
        .member-tag {
            display: inline-block;
            background-color: #eee;
            border-radius: 12px;
            padding: 4px 10px;
            margin-right: 6px;
            font-size: 14px;
        }
  </style>
</head>

<body>
  <div th:replace="~{fragments/header :: header(${user})}"></div>

  <a th:href="@{/trips/main-past}" class="back-link">&larr; Ïù¥Ï†Ñ</a>

  <div class="container">
    <div class="left-info">
      <div class="trip-title-row">
        <div class="trip-title" th:text="${trip.title}">Ïó¨Ìñâ Ï†úÎ™©</div>
        <button class="menu-dot" id="menuDotBtn">¬∑¬∑¬∑</button>
        <div class="menu-popup" id="menuPopup" style="display:none;">
          <ul class="menu-list">
            <li class="menu-item" th:onclick="'location.href=\'/trips/' + ${trip.id} + '/trip-plan-trip\''">
              <span class="menu-icon">‚úèÔ∏è</span>
              <span class="menu-text">Ìé∏Ïßë</span>
            </li>
            <li class="menu-item" onclick="openDeleteModal()">
              <span class="menu-icon">üóëÔ∏è</span>
              <span class="menu-text">ÏÇ≠Ï†ú</span>
            </li>
          </ul>
        </div>
      </div>

      <div class="info-table">
        <div class="info-row">
          <div class="info-label">ÏùºÏ†ï</div>
          <div class="info-value"
            th:text="${#temporals.format(trip.startDate,'yyyy.MM.dd') + ' - ' + #temporals.format(trip.endDate,'yyyy.MM.dd')}">
            2025.05.24 - 2025.05.30

          </div>
        </div>
        <div class="info-row">
          <div class="info-label">ÏàôÏÜå</div>
          <div class="info-value">
            <!-- ÏàôÏÜå ÌÖçÏä§Ìä∏ -->
            <span th:text="${trip.accommodation}">ÏàôÏÜå Ïù¥Î¶Ñ</span>
            <!-- ÎßÅÌÅ¨Í∞Ä ÏûàÏúºÎ©¥ ÌÅ¥Î¶≠ Í∞ÄÎä•Ìïú a, ÏóÜÏúºÎ©¥ span.disabled -->
            <a th:if="${trip.accommodationLink != null and trip.accommodationLink != ''}"
              th:href="${trip.accommodationLink}" class="info-link" target="_blank" rel="noopener">
              üìç
            </a>
            <span th:unless="${trip.accommodationLink != null}" class="info-link disabled">
            </span>
          </div>
        </div>
        <div class="info-row">
          <div class="info-label">Í∞ÄÎäî Ìé∏</div>
          <div class="info-value" th:text="${trip.departureTrip}"></div>
        </div>
        <div class="info-row">
          <div class="info-label">Ïò§Îäî Ìé∏</div>
          <div class="info-value" th:text="${trip.returnTrip}"></div>
        </div>
        <div class="info-row">
          <div class="info-label">ÌÉúÍ∑∏</div>
          <div class="info-value tag-list">
            <span th:each="tripTag : ${tags}" class="member-tag" th:text="${tripTag.tagName}">
              #ÌÉúÍ∑∏Ïù¥Î¶Ñ
            </span>
          </div>
        </div>
        <div class="info-row">
          <div class="info-label">Í≤ΩÎπÑ</div>
          <div class="info-value" th:text="${#numbers.formatInteger(totalExpenseAmount, 3, 'COMMA')} + Ïõê">0Ïõê</div>
          <a th:href="@{'/trips/' + ${trip.id} + '/expenses'}" class="info-link">ÎçîÎ≥¥Í∏∞</a>
        </div>
        <div class="info-row">
          <div class="info-label">ÎèôÌñâ</div>
          <div class="info-value">
            <span th:each="name : ${memberNames}" th:text="${name}" class="member-tag"></span>
            <span class="info-invite" onclick="openInviteModal()">Ï¥àÎåÄ</span>
          </div>
        </div>
      </div>
      <div class="side-btns">
        <a th:href="@{/trips/{tripId}/trip-plan(tripId=${tripId})}" class="side-btn">Í≥ÑÌöç</a>
        <a th:href="@{/trips/{tripId}/review(tripId=${tripId})}" class="side-btn selected">ÌõÑÍ∏∞</a>
      </div>
    </div>

    <div class="right-content">
      <div class="review-list">
        <!-- ÌõÑÍ∏∞ Î™©Î°ù -->
        <div th:each="review : ${reviews}" class="review-card">
          <div class="review-header" style="position:relative;">
            <!-- <div class="review-author"
              th:text="${review.userId != null and review.userId == 0 ? 'ÎπÑÌöåÏõê' : review.userId}">ÏûëÏÑ±Ïûê</div> -->

            <div class="review-author" th:text="${review.user.username}">ÏûëÏÑ±Ïûê</div>

            <button class="menu-dot review">&hellip;</button>
            <div class="review-menu-popup" style="display:none;">
              <button class="review-menu-btn review-edit-btn"
                th:if="${review.userId != null and review.userId == currentUserId}"
                th:onclick="'editReview(' + ${review.id} + ')'">ÏàòÏ†ï</button>
              <button class="review-menu-btn review-delete-btn"
                th:if="${review.userId != null and review.userId == currentUserId}"
                th:onclick="'deleteReview(' + ${review.id} + ')'">ÏÇ≠Ï†ú</button>
            </div>
          </div>
          <div class="review-content" th:if="${editReviewId != review.id}" th:text="${review.content}"></div>
          <div th:if="${editReviewId eq review.id}">
            <input class="review-edit-input" type="text" th:value="${review.content}"
              th:id="'edit-input-' + ${review.id}" />
            <button class="review-edit-btn2" type="button"
              th:attr="onclick='saveEdit(' + ${review.id} + ')'">Ï†ÄÏû•</button>
            <button class="review-cancel-btn2" type="button" onclick="cancelEdit()">Ï∑®ÏÜå</button>
          </div>
          <span class="review-like-heart" style="cursor:pointer;" th:onclick="'toggleLike(' + ${review.id} + ')'">
            <span class="review-like heart"
              th:classappend="${review.liked != null and review.liked ? 'liked' : ''}">‚ô°</span>
            <span class="like-count" th:text="${review.likeCount}">0</span>
          </span>
          <div class="review-images" th:if="${reviewPhotosMap[review.id] != null}">
            <span th:each="photo : ${reviewPhotosMap[review.id]}">
              <div class="review-image-wrapper" style="position:relative; display:inline-block;">
                <img th:if="${photo.fileType == 'image'}" th:src="${photo.imageUrl}" class="review-image" />
                <video th:if="${photo.fileType == 'video'}" th:src="${photo.imageUrl}" class="review-image" controls />
                <button type="button" th:if="${editReviewId eq review.id}" class="photo-delete-btn"
                  th:attr="onclick='window.deletePhoto(' + (${photo.id} != null ? ${photo.id} : (${photo.photoId} != null ? ${photo.photoId} : (${photo.pk} != null ? ${photo.pk} : 0))) + ', this)'"
                  style="position:absolute;top:2px;right:2px;background:#fff;border:none;border-radius:50%;width:24px;height:24px;cursor:pointer;font-size:18px;z-index:2;">
                  √ó
                </button>
              </div>
            </span>
            <!-- + Î≤ÑÌäº (ÏàòÏ†ï Î™®ÎìúÏùº ÎïåÎßå ÎÖ∏Ï∂ú) -->
            <div th:if="${editReviewId eq review.id}" class="review-image-wrapper"
              style="position:relative; display:inline-block;">
              <button type="button" class="photo-add-btn" onclick="triggerFileInput(this)">+</button>
              <input type="file" class="review-file-input" accept="image/*,video/*" style="display:none;"
                onchange="addPreviewImage(this, this.files)" multiple>
            </div>
          </div>
          <div class="review-meta">
            <span class="review-date"
              th:text="${review.createdAt != null ? #temporals.format(review.createdAt, 'yyyy.MM.dd HH:mm') : ''}">ÏûëÏÑ±Ïùº</span>
          </div>
        </div>
        <div th:if="${reviews == null or #lists.isEmpty(reviews)}" class="no-reviews"
          style="text-align:center;padding:20px;color:#666;">
          ÏïÑÏßÅ ÏûëÏÑ±Îêú ÌõÑÍ∏∞Í∞Ä ÏóÜÏäµÎãàÎã§.
        </div>
      </div>
      <form class="review-input-area" method="post" th:action="@{'/trips/' + ${trip.id} + '/review'}"
        enctype="multipart/form-data">
        <input type="hidden" name="userId" th:value="${user != null ? user.id : 0}">
        <input class="review-input" name="content" placeholder="ÌõÑÍ∏∞Î•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî." maxlength="140">
        <input type="file" class="review-file" accept="image/*,video/*" multiple name="file" style="display:none;">
        <button type="button" class="review-attach">ÏÇ¨ÏßÑ Ï≤®Î∂Ä</button>
        <button type="submit" class="review-submit">Îì±Î°ù</button>
      </form>
      <div class="review-warning" style="color:#e74c3c;font-size:14px;margin-top:4px;"></div>
      <div class="review-file-list"></div>
    </div>

    <!-- ‚úÖ ÌåùÏóÖ Íµ¨Ï°∞ -->
    <div id="inviteModal" class="invite-modal" style="display:none;">
      <div class="invite-modal-content">
        <div class="invite-title">Ï¥àÎåÄÌï† Ïú†Ï†ÄÏùò Ïù¥Î©îÏùºÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî!</div>
        <div class="invite-form-row">
          <input type="email" id="inviteEmailInput" class="invite-input" placeholder="example@email.com" />
          <button class="invite-send-btn" onclick="sendInvite()">Ï†ÑÏÜ°</button>
        </div>
        <div class="invite-message" id="inviteMessage"></div>
        <button class="invite-close-btn" onclick="closeInviteModal()">Îã´Í∏∞</button>
      </div>
    </div>

    <!-- Ïù¥ÎØ∏ÏßÄ ÌôïÎåÄ Î™®Îã¨ -->
    <div id="photoModal"
      style="display:none; position:fixed; z-index:9999; left:0; top:0; width:100vw; height:100vh; background:rgba(0,0,0,0.7); align-items:center; justify-content:center;">
      <img id="modalImage" src=""
        style="max-width:90vw; max-height:90vh; border-radius:12px; box-shadow:0 4px 24px rgba(0,0,0,0.2);" />
    </div>

    <script th:inline="javascript">
      // ÏÑúÎ≤ÑÏóêÏÑú userId, tripIdÎ•º JS Î≥ÄÏàòÎ°ú Ï†ÑÎã¨
      var currentUserId = /*[[${user != null ? user.id : 0}]]*/ 0;
      var tripId = /*[[${trip.id}]]*/ 0;

      document.addEventListener('DOMContentLoaded', function () {
        // Î©îÎâ¥(¬∑¬∑¬∑) Î≤ÑÌäº ÌÅ¥Î¶≠ Ïãú ÌåùÏóÖ ÌÜ†Í∏Ä
        document.getElementById('menuDotBtn').addEventListener('click', function () {
          const pop = document.getElementById('menuPopup');
          pop.style.display = pop.style.display === 'none' ? 'block' : 'none';
        });

        // Î∞îÍπ• ÌÅ¥Î¶≠ Ïãú Î©îÎâ¥ ÌåùÏóÖ Îã´Í∏∞
        document.addEventListener('click', function (e) {
          const menuPopup = document.getElementById('menuPopup');
          if (menuPopup && !menuPopup.contains(e.target) && e.target.id !== 'menuDotBtn') {
            menuPopup.style.display = 'none';
          }
        });

        // ÏÇ¨Ïù¥Îìú Î≤ÑÌäº ÏÑ†ÌÉù ÏÉÅÌÉú ÌÜ†Í∏Ä
        document.querySelectorAll('.side-btn').forEach(function (btn) {
          btn.addEventListener('click', function () {
            document.querySelectorAll('.side-btn').forEach(function (b) {
              b.classList.remove('selected');
            });
            btn.classList.add('selected');
          });
        });

        // Ï¥àÎåÄ Î™®Îã¨ Í¥ÄÎ†® Ìï®ÏàòÎì§
        function openInviteModal() {
          document.getElementById("inviteModal").style.display = "flex";
        }

        function closeInviteModal() {
          document.getElementById("inviteModal").style.display = "none";
          document.getElementById("inviteEmailInput").value = "";
          document.getElementById("inviteMessage").textContent = "";
        }

        async function sendInvite() {
          const email = document.getElementById("inviteEmailInput").value;
          const message = document.getElementById("inviteMessage");
          const tripId = /*[[${trip.id}]]*/ 0;

          try {
            const response = await fetch(`/trips/${tripId}/invite`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ email })
            });
            const result = await response.json();

            if (response.ok) {
              message.style.color = "green";
              message.textContent = `"${result.username}" ÎãòÏùÑ Ï¥àÎåÄÌñàÏñ¥Ïöî!`;
            } else {
              message.style.color = "red";
              message.textContent = result.error || "Ï¥àÎåÄ Ïã§Ìå®";
            }
          } catch (e) {
            message.style.color = "red";
            message.textContent = "ÏÑúÎ≤Ñ Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.";
          }
        }

        // Ï¥àÎåÄ Î≤ÑÌäº ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏
        document.querySelector('.info-invite').addEventListener('click', function (e) {
          e.preventDefault();
          openInviteModal();
        });

        // Ï¥àÎåÄ Î™®Îã¨ Îã´Í∏∞ Î≤ÑÌäº
        document.querySelector('.invite-close-btn').addEventListener('click', function () {
          closeInviteModal();
        });

        // ÌõÑÍ∏∞ Îì±Î°ù Í∏∞Îä•
        function setupReviewForm() {
          const form = document.querySelector('.review-input-area');
          const input = form.querySelector('.review-input');
          const warningDiv = document.querySelector('.review-warning');
          const fileInput = form.querySelector('.review-file');
          const fileListDiv = document.querySelector('.review-file-list');

          // Í∏ÄÏûêÏàò Ï†úÌïú Í≤ΩÍ≥† + Îì±Î°ù Î≤ÑÌäº ÎπÑÌôúÏÑ±Ìôî
          input.addEventListener('input', function () {
            if (input.value.length > 140) {
              warningDiv.textContent = 'Í∏ÄÏûêÏàò Ï†úÌïú 140ÏûêÎ•º Ï¥àÍ≥ºÌñàÏäµÎãàÎã§.';
              form.querySelector('.review-submit').disabled = true;
            } else {
              warningDiv.textContent = '';
              form.querySelector('.review-submit').disabled = false;
            }
          });

          form.addEventListener('submit', function (e) {
            if (form.classList.contains('submitting')) {
              e.preventDefault();
              return;
            }
            form.classList.add('submitting');
            const text = input.value.trim();
            if (!text) {
              e.preventDefault();
              warningDiv.textContent = 'ÌõÑÍ∏∞ ÎÇ¥Ïö©ÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.';
              return;
            }

            if (text.length > 140) {
              e.preventDefault();
              warningDiv.textContent = 'Í∏ÄÏûêÏàò Ï†úÌïú 140ÏûêÎ•º Ï¥àÍ≥ºÌñàÏäµÎãàÎã§.';
              form.querySelector('.review-submit').disabled = true;
              return;
            }

            const files = window.selectedFiles || [];
            if (files.length > 10) {
              e.preventDefault();
              warningDiv.textContent = 'ÏÇ¨ÏßÑ Ï≤®Î∂ÄÎäî ÏµúÎåÄ 10Í∞úÍπåÏßÄ Í∞ÄÎä•Ìï©ÎãàÎã§.';
              return;
            }
          });
        }

        // ÌõÑÍ∏∞ ÏàòÏ†ï/ÏÇ≠Ï†ú Í∏∞Îä•
        window.editReview = function (reviewId) {
          const url = new URL(window.location.href);
          url.searchParams.set('editReviewId', reviewId);
          window.location.href = url.toString();
        };

        window.saveEdit = function (reviewId) {
          const input = document.getElementById('edit-input-' + reviewId);
          const content = input.value.trim();
          if (!content) {
            alert('ÎÇ¥Ïö©ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî.');
            return;
          }

          const formData = new FormData();
          formData.append('content', content);

          // ÏÉàÎ°ú Ï∂îÍ∞ÄÎêú ÌååÏùºÎì§
          const fileInputs = document.querySelectorAll('.review-file-input');
          fileInputs.forEach(input => {
            if (input.files) {
              Array.from(input.files).forEach(file => {
                formData.append('file', file);
              });
            }
          });

          // ÏÇ≠Ï†úÌï† ÏÇ¨ÏßÑ id Ï∂îÍ∞Ä
          formData.append('deletePhotoIds', JSON.stringify(window.deletedPhotoIds || []));

          fetch(`/trips/${tripId}/review/${reviewId}/edit`, {
            method: 'POST',
            body: formData
          })
            .then(response => {
              if (response.ok) window.location.href = window.location.pathname;
              else alert('ÏàòÏ†ï Ïã§Ìå®');
            })
            .catch(error => {
              alert('ÏàòÏ†ï Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§: ' + error.message);
            });
        };

        window.cancelEdit = function () {
          window.location.href = window.location.pathname;
        };

        // Ï¢ãÏïÑÏöî ÌÜ†Í∏Ä Í∏∞Îä•
        window.toggleLike = function (reviewId) {
          const heart = document.querySelector(`.review-like-heart[onclick="toggleLike(${reviewId})"] .review-like`);
          const count = document.querySelector(`.review-like-heart[onclick="toggleLike(${reviewId})"] .like-count`);
          const isLiked = heart.classList.contains('liked');
          const method = isLiked ? 'DELETE' : 'POST';
          const url = `/trips/${tripId}/review/${reviewId}/like`;

          fetch(url, { method })
            .then(response => {
              if (response.ok) {
                if (isLiked) {
                  heart.textContent = '‚ô°';
                  heart.classList.remove('liked');
                  count.textContent = parseInt(count.textContent) - 1;
                } else {
                  heart.textContent = '‚ô•';
                  heart.classList.add('liked');
                  count.textContent = parseInt(count.textContent) + 1;
                }
              }
            });
        };

        // ÌõÑÍ∏∞ Ïπ¥ÎìúÏùò ... Î≤ÑÌäº ÌÅ¥Î¶≠ Ïãú Î©îÎâ¥ ÌÜ†Í∏Ä
        document.querySelectorAll('.menu-dot.review').forEach(function (btn) {
          btn.addEventListener('click', function (e) {
            e.stopPropagation();
            // Î™®Îì† Î©îÎâ¥ Îã´Í∏∞
            document.querySelectorAll('.review-menu-popup').forEach(function (popup) {
              popup.style.display = 'none';
            });
            // ÌòÑÏû¨ Ïπ¥ÎìúÏùò Î©îÎâ¥Îßå Ïó¥Í∏∞
            const popup = btn.nextElementSibling;
            if (popup) {
              popup.style.display = (popup.style.display === 'none' || popup.style.display === '') ? 'flex' : 'none';
            }
          });
        });

        // Î∞îÍπ• ÌÅ¥Î¶≠ Ïãú Î©îÎâ¥ Îã´Í∏∞
        document.addEventListener('click', function () {
          document.querySelectorAll('.review-menu-popup').forEach(function (popup) {
            popup.style.display = 'none';
          });
        });

        window.deleteReview = function (reviewId) {
          if (confirm('Ï†ïÎßê ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) {
            fetch(`/trips/${tripId}/review/${reviewId}`, {
              method: 'DELETE'
            })
              .then(response => {
                if (response.ok) window.location.href = window.location.pathname;
                else alert('ÏÇ≠Ï†ú Ïã§Ìå®');
              });
          }
        };

        // ÏÇ¨ÏßÑ Ï≤®Î∂Ä Í∏∞Îä• Î∞è ÌååÏùº ÎØ∏Î¶¨Î≥¥Í∏∞/ÏÇ≠Ï†ú
        const form = document.querySelector('.review-input-area');
        const fileInput = form.querySelector('.review-file');
        const fileListDiv = document.querySelector('.review-file-list');
        let selectedFiles = [];

        // ÌååÏùº Ï≤®Î∂Ä Î≤ÑÌäº ÌÅ¥Î¶≠
        document.querySelector('.review-attach').addEventListener('click', function () {
          fileInput.click();
        });

        // ÌååÏùº ÏÑ†ÌÉù Ïãú
        fileInput.addEventListener('change', function (e) {
          selectedFiles = Array.from(e.target.files);
          renderFileList();
          updateFileInput();
        });

        // ÌååÏùº Î™©Î°ù Î†åÎçîÎßÅ
        function renderFileList() {
          fileListDiv.innerHTML = '';
          selectedFiles.forEach((file, idx) => {
            const fileDiv = document.createElement('span');
            fileDiv.style.display = 'inline-block';
            fileDiv.style.marginRight = '8px';
            fileDiv.style.background = '#f5f5f5';
            fileDiv.style.borderRadius = '12px';
            fileDiv.style.padding = '4px 10px';
            fileDiv.style.fontSize = '16px';
            fileDiv.style.marginTop = '8px';
            fileDiv.textContent = file.name + ' ';
            const removeBtn = document.createElement('span');
            removeBtn.textContent = '‚úï';
            removeBtn.style.cursor = 'pointer';
            removeBtn.style.marginLeft = '4px';
            removeBtn.onclick = function () {
              selectedFiles.splice(idx, 1);
              updateFileInput();
              renderFileList();
            };
            fileDiv.appendChild(removeBtn);
            fileListDiv.appendChild(fileDiv);
          });
        }

        // ÌååÏùº input ÏóÖÎç∞Ïù¥Ìä∏
        function updateFileInput() {
          const dataTransfer = new DataTransfer();
          selectedFiles.forEach(file => dataTransfer.items.add(file));
          fileInput.files = dataTransfer.files;
        }

        // Ìèº Ï†úÏ∂ú
        form.addEventListener('submit', function (e) {
          e.preventDefault();

          if (form.classList.contains('submitting')) return;
          form.classList.add('submitting');

          const content = form.querySelector('.review-input').value.trim();
          if (!content) {
            alert('ÌõÑÍ∏∞ ÎÇ¥Ïö©ÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.');
            form.classList.remove('submitting');
            return;
          }

          if (content.length > 140) {
            alert('Í∏ÄÏûêÏàò Ï†úÌïú 140ÏûêÎ•º Ï¥àÍ≥ºÌñàÏäµÎãàÎã§.');
            form.classList.remove('submitting');
            return;
          }

          if (selectedFiles.length > 10) {
            alert('ÏÇ¨ÏßÑ Ï≤®Î∂ÄÎäî ÏµúÎåÄ 10Í∞úÍπåÏßÄ Í∞ÄÎä•Ìï©ÎãàÎã§.');
            form.classList.remove('submitting');
            return;
          }

          const formData = new FormData();
          formData.append('content', content);

          selectedFiles.forEach(file => {
            formData.append('file', file);
          });

          fetch(form.action, {
            method: 'POST',
            body: formData
          })
            .then(response => {
              form.classList.remove('submitting');
              if (response.ok) {
                window.location.reload();
              } else {
                throw new Error('Ï†ÄÏû• Ïã§Ìå®');
              }
            })
            .catch(error => {
              form.classList.remove('submitting');
              alert('Ï†ÄÏû• Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§: ' + error.message);
            });
        });

        // + Î≤ÑÌäºÏúºÎ°ú ÌååÏùº Ï∂îÍ∞Ä
        window.triggerFileInput = function (btn) {
          btn.nextElementSibling.click();
        }

        window.addPreviewImage = function (input, files) {
          const container = input.parentElement.parentElement;
          selectedFiles = Array.from(files);
          renderFileList();
          updateFileInput();
          Array.from(files).forEach((file, idx) => {
            const reader = new FileReader();
            reader.onload = function (e) {
              const div = document.createElement('div');
              div.className = 'review-image-wrapper';
              div.style.position = 'relative';
              div.style.display = 'inline-block';
              const img = document.createElement('img');
              img.className = 'review-image';
              img.src = e.target.result;
              const deleteBtn = document.createElement('button');
              deleteBtn.type = 'button';
              deleteBtn.className = 'photo-delete-btn';
              deleteBtn.style.position = 'absolute';
              deleteBtn.style.top = '2px';
              deleteBtn.style.right = '2px';
              deleteBtn.style.background = '#fff';
              deleteBtn.style.border = 'none';
              deleteBtn.style.borderRadius = '50%';
              deleteBtn.style.width = '24px';
              deleteBtn.style.height = '24px';
              deleteBtn.style.cursor = 'pointer';
              deleteBtn.style.fontSize = '18px';
              deleteBtn.style.zIndex = '2';
              deleteBtn.textContent = '√ó';
              deleteBtn.onclick = function () {
                selectedFiles.splice(idx, 1);
                div.remove();
                renderFileList();
                updateFileInput();
              };
              div.appendChild(img);
              div.appendChild(deleteBtn);
              container.insertBefore(div, input.parentElement);
            };
            reader.readAsDataURL(file);
          });
        }

        // ÌõÑÍ∏∞ Ïù¥ÎØ∏ÏßÄ ÌÅ¥Î¶≠ Ïãú Î™®Îã¨Î°ú ÌÅ¨Í≤å Î≥¥Í∏∞
        document.querySelectorAll('.review-image').forEach(function (img) {
          img.addEventListener('click', function () {
            var modal = document.getElementById('photoModal');
            var modalImg = document.getElementById('modalImage');
            modalImg.src = img.src;
            modal.style.display = 'flex';
          });
        });

        // Î™®Îã¨ Î∞îÍπ• ÌÅ¥Î¶≠ Ïãú Îã´Í∏∞
        document.getElementById('photoModal').addEventListener('click', function (e) {
          if (e.target === this) {
            this.style.display = 'none';
            document.getElementById('modalImage').src = '';
          }
        });

        setupReviewForm();

        // Ïù¥ÎØ∏ÏßÄ ÏÇ≠Ï†ú Ìï®Ïàò
        window.deletePhoto = function (photoId, btn) {
          if (!confirm('Ï†ïÎßê Ïù¥ ÏÇ¨ÏßÑÏùÑ ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) return;
          window.deletedPhotoIds = window.deletedPhotoIds || [];
          window.deletedPhotoIds.push(photoId);
          const wrapper = btn.closest('.review-image-wrapper');
          if (wrapper) wrapper.remove();
        };
      });
      function openDeleteModal() {
      document.getElementById("deleteModal").style.display = "flex";
      }
      function closeDeleteModal() {
      document.getElementById("deleteModal").style.display = "none";
      }
      async function confirmDelete() {
      const tripId = /*[[${trip.id}]]*/ 0;
      try {
          const response = await fetch(`/trips/${tripId}/delete`, {
          method: "POST"
          });
          if (response.ok) {
          window.location.href = "/"; // TRIP ON Î°úÍ≥†ÏôÄ ÎèôÏùºÌïú Î©îÏù∏ÌéòÏù¥ÏßÄ Ïù¥Îèô
          } else {
          alert("ÏÇ≠Ï†úÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.");
          }
      } catch (e) {
          alert("ÏÑúÎ≤Ñ Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.");
      }
      }
    </script>
    <!--  ÏÇ≠Ï†ú ÌôïÏù∏ ÌåùÏóÖ -->
<div id="deleteModal" class="delete-modal" style="display: none;">
  <div class="delete-modal-content">
    <div class="delete-title">Ï†ïÎßê Ïù¥ Ïó¨ÌñâÏùÑ ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?</div>
    <div class="delete-buttons">
      <button class="delete-btn" onclick="confirmDelete()">ÏÇ≠Ï†ú</button>
      <button class="cancel-btn" onclick="closeDeleteModal()">Ï∑®ÏÜå</button>
    </div>
  </div>
</div>
</body>

</html>